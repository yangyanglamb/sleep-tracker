<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®°å½•ç®¡ç† - ç¡çœ ä¸é¥®é£Ÿè®°å½•</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 1000px;
      margin: 0 auto;
      padding: 30px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 28px;
      color: #333;
    }

    .back-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      transition: transform 0.2s;
    }

    .back-btn:hover {
      transform: translateY(-2px);
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .tab-btn {
      padding: 15px 20px;
      border: none;
      background: transparent;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      font-size: 16px;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: #f0f0f0;
      color: #667eea;
      border-bottom: 3px solid #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .form-row.three {
      grid-template-columns: 1fr 1fr 1fr;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #666;
      margin-left: 10px;
    }

    .statistics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }

    .stat-unit {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .records-list {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
    }

    .record-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: white;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }

    .record-item:hover {
      background: #f8f9fa;
    }

    .record-item input[type="checkbox"] {
      width: auto;
      margin-right: 15px;
      cursor: pointer;
    }

    .record-info {
      flex: 1;
    }

    .record-text {
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
    }

    .record-time {
      font-size: 12px;
      color: #999;
    }

    .record-delete {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 10px;
    }

    .record-delete:hover {
      background: #ff5252;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .action-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 10px;
      margin-bottom: 20px;
    }

    .meal-type-select {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .meal-option {
      padding: 10px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      transition: all 0.2s;
    }

    .meal-option:hover {
      border-color: #667eea;
    }

    .meal-option.selected {
      border-color: #667eea;
      background: #f0f4ff;
      color: #667eea;
    }

    /* è§†å›¾åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .view-btn {
      background: #f0f0f0;
      color: #666;
      padding: 10px 16px;
      font-size: 14px;
      flex: 1;
      max-width: 150px;
    }

    .view-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* å‘¨ä½œæ¯è¡¨æ ·å¼ */
    .schedule-container {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      overflow-x: auto;
    }

    .schedule-grid {
      display: grid;
      grid-template-columns: 40px repeat(7, 1fr);
      gap: 1px;
      background: #ddd;
      border: 1px solid #ddd;
      min-width: 600px;
    }

    .schedule-header {
      background: #667eea;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
    }

    .schedule-time {
      background: #f8f9fa;
      color: #666;
      padding: 5px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
    }

    .schedule-cell {
      background: white;
      min-height: 30px;
      position: relative;
      padding: 2px;
    }

    .time-block {
      position: absolute;
      left: 1px;
      right: 1px;
      border-radius: 3px;
      font-size: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      overflow: hidden;
      white-space: nowrap;
    }

    .time-block.sleep {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .time-block.meal {
      background: #4facfe;
      height: 8px;
      min-height: 8px;
    }

    .time-block.tooltip {
      position: relative;
    }

    .time-block.tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      z-index: 10;
      margin-bottom: 5px;
    }

    /* æ—¥å†è§†å›¾æ ·å¼ */
    .calendar-container {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
    }

    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 20px;
    }

    .calendar-nav button {
      padding: 8px 16px;
      font-size: 14px;
    }

    .calendar-nav span {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      min-width: 150px;
      text-align: center;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    .calendar-weekday {
      text-align: center;
      font-weight: 600;
      color: #667eea;
      padding: 10px;
      font-size: 14px;
    }

    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70px;
    }

    .calendar-day:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }

    .calendar-day.other-month {
      color: #ccc;
      background: #fafafa;
    }

    .calendar-day.has-data {
      background: #f0f4ff;
      border-color: #667eea;
    }

    .calendar-day-number {
      font-weight: 600;
      font-size: 14px;
      color: #333;
    }

    .calendar-day.other-month .calendar-day-number {
      color: #ccc;
    }

    .calendar-indicators {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: center;
      font-size: 10px;
      margin-top: 4px;
    }

    .indicator-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .indicator-dot.sleep {
      background: #667eea;
    }

    .indicator-dot.meal {
      background: #4facfe;
    }

    .calendar-detail {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      min-height: 100px;
    }

    .calendar-detail-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .calendar-detail-item {
      padding: 8px 0;
      font-size: 13px;
      color: #666;
      border-bottom: 1px solid #e0e0e0;
    }

    .calendar-detail-item:last-child {
      border-bottom: none;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .tabs {
        grid-template-columns: 1fr;
      }

      .statistics {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .form-row.three {
        grid-template-columns: 1fr;
      }

      .filter-group {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‹ è®°å½•ç®¡ç†</h1>
      <a href="/" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('view')">ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡</button>
      <button class="tab-btn" onclick="switchTab('add')">â• æ·»åŠ è®°å½•</button>
      <button class="tab-btn" onclick="switchTab('delete')">ğŸ—‘ï¸ åˆ é™¤è®°å½•</button>
    </div>

    <!-- æŸ¥çœ‹ç»Ÿè®¡æ ‡ç­¾é¡µ -->
    <div id="view-tab" class="tab-content active">
      <div class="filter-group">
        <input type="date" id="filterStart" placeholder="å¼€å§‹æ—¥æœŸ">
        <input type="date" id="filterEnd" placeholder="ç»“æŸæ—¥æœŸ">
        <select id="filterType">
          <option value="all">æ‰€æœ‰è®°å½•</option>
          <option value="sleep">ç¡çœ è®°å½•</option>
          <option value="meal">é¥®é£Ÿè®°å½•</option>
        </select>
        <button onclick="loadStatistics()">æŸ¥è¯¢</button>
      </div>

      <div class="statistics" id="statistics"></div>

      <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
      <div style="display: flex; gap: 10px; margin-top: 30px; margin-bottom: 20px;">
        <button class="view-btn active" onclick="switchViewType('list')">ğŸ“‹ åˆ—è¡¨è§†å›¾</button>
        <button class="view-btn" onclick="switchViewType('schedule')">ğŸ“Š å‘¨ä½œæ¯è¡¨</button>
        <button class="view-btn" onclick="switchViewType('calendar')">ğŸ“… æœˆå†è§†å›¾</button>
      </div>

      <!-- åˆ—è¡¨è§†å›¾ -->
      <div id="listView" class="view-container active">
        <h3 style="margin-bottom: 15px;">è®°å½•è¯¦æƒ…</h3>
        <div class="records-list" id="filterResults"></div>
      </div>

      <!-- å‘¨ä½œæ¯è¡¨è§†å›¾ -->
      <div id="scheduleView" class="view-container" style="display: none;">
        <h3 style="margin-bottom: 15px;">å‘¨ä½œæ¯è¡¨</h3>
        <div class="schedule-container">
          <div id="weeklySchedule"></div>
        </div>
      </div>

      <!-- æ—¥å†è§†å›¾ -->
      <div id="calendarView" class="view-container" style="display: none;">
        <h3 style="margin-bottom: 15px;">æœˆå†è§†å›¾</h3>
        <div class="calendar-container">
          <div class="calendar-nav">
            <button onclick="previousMonth()">â€¹ ä¸Šæœˆ</button>
            <span id="calendarMonth"></span>
            <button onclick="nextMonth()">ä¸‹æœˆ â€º</button>
          </div>
          <div id="calendarGrid" class="calendar-grid"></div>
          <div id="calendarDetail" class="calendar-detail"></div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ è®°å½•æ ‡ç­¾é¡µ -->
    <div id="add-tab" class="tab-content">
      <h3 style="margin-bottom: 20px;">æ·»åŠ ç¡çœ è®°å½•</h3>
      <div class="form-row three">
        <div class="form-group">
          <label>æ—¥æœŸ</label>
          <input type="date" id="sleepDate">
        </div>
        <div class="form-group">
          <label>å¼€å§‹æ—¶é—´</label>
          <input type="time" id="sleepStart">
        </div>
        <div class="form-group">
          <label>ç»“æŸæ—¶é—´</label>
          <input type="time" id="sleepEnd">
        </div>
      </div>
      <button onclick="addSleepRecord()">æ·»åŠ ç¡çœ è®°å½•</button>

      <hr style="margin: 40px 0; border: none; border-top: 1px solid #ddd;">

      <h3 style="margin-bottom: 20px;">æ·»åŠ é¥®é£Ÿè®°å½•</h3>
      <div class="form-row">
        <div class="form-group">
          <label>æ—¥æœŸ</label>
          <input type="date" id="mealDate">
        </div>
        <div class="form-group">
          <label>æ—¶é—´</label>
          <input type="time" id="mealTime">
        </div>
      </div>
      <div class="form-group">
        <label>é¥®é£Ÿç±»å‹</label>
        <div class="meal-type-select">
          <div class="meal-option" onclick="selectMealType(this, 'æ—©é¤')">æ—©é¤</div>
          <div class="meal-option" onclick="selectMealType(this, 'åˆé¤')">åˆé¤</div>
          <div class="meal-option" onclick="selectMealType(this, 'æ™šé¤')">æ™šé¤</div>
          <div class="meal-option" onclick="selectMealType(this, 'åŠ é¤')">åŠ é¤</div>
          <div class="meal-option" onclick="selectMealType(this, 'é¥®æ°´')">é¥®æ°´</div>
          <div class="meal-option" onclick="selectMealType(this, 'å…¶ä»–')">å…¶ä»–</div>
        </div>
      </div>
      <button onclick="addMealRecord()" style="margin-top: 20px;">æ·»åŠ é¥®é£Ÿè®°å½•</button>

      <div id="addMessage" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
    </div>

    <!-- åˆ é™¤è®°å½•æ ‡ç­¾é¡µ -->
    <div id="delete-tab" class="tab-content">
      <div class="action-bar">
        <select id="deleteType">
          <option value="sleep">ç¡çœ è®°å½•</option>
          <option value="meal">é¥®é£Ÿè®°å½•</option>
        </select>
        <button onclick="loadDeleteList()">åŠ è½½è®°å½•</button>
        <button class="btn-secondary" onclick="toggleSelectAll()">å…¨é€‰</button>
        <button class="btn-secondary" style="background: #ff6b6b; color: white;" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</button>
      </div>

      <div class="records-list" id="deleteRecordsList"></div>
    </div>
  </div>

  <script>
    let currentMealType = 'æ—©é¤';
    let selectedRecords = new Set();

    // åˆå§‹åŒ–
    function init() {
      const today = new Date().toISOString().split('T')[0];
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      document.getElementById('filterStart').value = sevenDaysAgo.toISOString().split('T')[0];
      document.getElementById('filterEnd').value = today;
      document.getElementById('mealDate').value = today;
      document.getElementById('sleepDate').value = today;

      // è®¾ç½®é»˜è®¤æ—¶é—´
      const now = new Date();
      const timeStr = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
      document.getElementById('mealTime').value = timeStr;
      document.getElementById('sleepStart').value = timeStr;
      document.getElementById('sleepEnd').value = timeStr;

      loadStatistics();
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      document.getElementById(tab + '-tab').classList.add('active');
      event.target.classList.add('active');

      if (tab === 'delete') {
        loadDeleteList();
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStatistics() {
      const start = document.getElementById('filterStart').value;
      const end = document.getElementById('filterEnd').value;
      const type = document.getElementById('filterType').value;

      try {
        // è®¡ç®—å¤©æ•°
        const startDate = new Date(start);
        const endDate = new Date(end);
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));

        const response = await fetch(`/api/statistics?days=${days}`);
        const stats = await response.json();

        // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
        let statsHtml = '';
        if (type === 'sleep' || type === 'all') {
          statsHtml += `
            <div class="stat-card">
              <h3>ç¡çœ è®°å½•æ•°</h3>
              <div class="stat-value">${stats.sleep.totalRecords}</div>
              <div class="stat-unit">æ¡è®°å½•</div>
            </div>
            <div class="stat-card">
              <h3>å¹³å‡ç¡çœ æ—¶é•¿</h3>
              <div class="stat-value">${stats.sleep.avgHours}</div>
              <div class="stat-unit">å°æ—¶</div>
            </div>
            <div class="stat-card" style="border-left-color: #4facfe;">
              <h3>æ€»ç¡çœ æ—¶é•¿</h3>
              <div class="stat-value">${stats.sleep.totalHours}</div>
              <div class="stat-unit">å°æ—¶</div>
            </div>
          `;
        }
        if (type === 'meal' || type === 'all') {
          statsHtml += `
            <div class="stat-card" style="border-left-color: #ffd93d;">
              <h3>é¥®é£Ÿè®°å½•æ•°</h3>
              <div class="stat-value">${stats.meals.totalRecords}</div>
              <div class="stat-unit">æ¡è®°å½•</div>
            </div>
          `;
        }

        document.getElementById('statistics').innerHTML = statsHtml;

        // åŠ è½½è¯¦ç»†è®°å½•
        await loadFilteredRecords(start, end, type);
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
      }
    }

    // åŠ è½½ç­›é€‰åçš„è®°å½•
    async function loadFilteredRecords(start, end, type) {
      try {
        let html = '';

        if (type === 'sleep' || type === 'all') {
          const response = await fetch(`/api/records/filter?type=sleep&start=${start}&end=${end}`);
          const records = await response.json();
          if (records.length > 0) {
            html += '<h4 style="margin-bottom: 15px; margin-top: 20px; color: #667eea;">ç¡çœ è®°å½•</h4>';
            records.forEach(record => {
              html += `<div class="record-item">
                <div class="record-info">
                  <div class="record-text">${record.display}</div>
                </div>
              </div>`;
            });
          }
        }

        if (type === 'meal' || type === 'all') {
          const response = await fetch(`/api/records/filter?type=meal&start=${start}&end=${end}`);
          const records = await response.json();
          if (records.length > 0) {
            html += '<h4 style="margin-bottom: 15px; margin-top: 20px; color: #4facfe;">é¥®é£Ÿè®°å½•</h4>';
            records.forEach(record => {
              html += `<div class="record-item">
                <div class="record-info">
                  <div class="record-text">${record.display}</div>
                </div>
              </div>`;
            });
          }
        }

        if (html === '') {
          html = '<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</div>';
        }

        document.getElementById('filterResults').innerHTML = html;
      } catch (error) {
        console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
      }
    }

    // æ·»åŠ ç¡çœ è®°å½•
    async function addSleepRecord() {
      const date = document.getElementById('sleepDate').value;
      const start = document.getElementById('sleepStart').value;
      const end = document.getElementById('sleepEnd').value;

      if (!date || !start || !end) {
        alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
        return;
      }

      const sleepStart = `${date}T${start}:00+08:00`;
      const sleepEnd = `${date}T${end}:00+08:00`;

      try {
        const response = await fetch('/api/sleep-records/custom', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sleep_start: sleepStart, sleep_end: sleepEnd })
        });
        const result = await response.json();

        showMessage(`âœ… ${result.display}`, 'success');
        init(); // é‡ç½®è¡¨å•å’Œåˆ·æ–°ç»Ÿè®¡
      } catch (error) {
        showMessage('âŒ æ·»åŠ å¤±è´¥', 'error');
      }
    }

    // æ·»åŠ é¥®é£Ÿè®°å½•
    async function addMealRecord() {
      const date = document.getElementById('mealDate').value;
      const time = document.getElementById('mealTime').value;

      if (!date || !time) {
        alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
        return;
      }

      const mealTime = `${date}T${time}:00+08:00`;

      try {
        const response = await fetch('/api/meal-records/custom', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ meal_time: mealTime, meal_type: currentMealType })
        });
        const result = await response.json();

        showMessage(`âœ… ${result.display}`, 'success');
        init(); // é‡ç½®è¡¨å•
      } catch (error) {
        showMessage('âŒ æ·»åŠ å¤±è´¥', 'error');
      }
    }

    // é€‰æ‹©é¥®é£Ÿç±»å‹
    function selectMealType(element, type) {
      document.querySelectorAll('.meal-option').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      currentMealType = type;
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
      const msgEl = document.getElementById('addMessage');
      msgEl.textContent = text;
      msgEl.style.background = type === 'success' ? '#e8f5e9' : '#ffebee';
      msgEl.style.color = type === 'success' ? '#2e7d32' : '#c62828';
      msgEl.style.display = 'block';
      setTimeout(() => {
        msgEl.style.display = 'none';
      }, 3000);
    }

    // åŠ è½½åˆ é™¤åˆ—è¡¨
    async function loadDeleteList() {
      const type = document.getElementById('deleteType').value;
      selectedRecords.clear();

      try {
        let html = '';
        if (type === 'sleep') {
          const response = await fetch('/api/sleep-records?limit=100');
          const records = await response.json();
          if (records.length === 0) {
            html = '<div class="empty-state">æ²¡æœ‰ç¡çœ è®°å½•</div>';
          } else {
            records.forEach(record => {
              html += `<div class="record-item">
                <input type="checkbox" onchange="toggleRecord('${record.id}', '${type}', this)">
                <div class="record-info">
                  <div class="record-text">${record.display}</div>
                </div>
              </div>`;
            });
          }
        } else {
          const response = await fetch('/api/meal-records?limit=100');
          const records = await response.json();
          if (records.length === 0) {
            html = '<div class="empty-state">æ²¡æœ‰é¥®é£Ÿè®°å½•</div>';
          } else {
            records.forEach(record => {
              html += `<div class="record-item">
                <input type="checkbox" onchange="toggleRecord('${record.id}', '${type}', this)">
                <div class="record-info">
                  <div class="record-text">${record.display}</div>
                </div>
              </div>`;
            });
          }
        }
        document.getElementById('deleteRecordsList').innerHTML = html;
      } catch (error) {
        console.error('åŠ è½½åˆ—è¡¨å¤±è´¥:', error);
      }
    }

    // åˆ‡æ¢é€‰ä¸­è®°å½•
    function toggleRecord(id, type, checkbox) {
      const key = `${type}:${id}`;
      if (checkbox.checked) {
        selectedRecords.add(key);
      } else {
        selectedRecords.delete(key);
      }
    }

    // å…¨é€‰
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('#deleteRecordsList input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => {
        cb.checked = !allChecked;
        cb.onchange();
      });
    }

    // åˆ é™¤é€‰ä¸­
    async function deleteSelected() {
      if (selectedRecords.size === 0) {
        alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
        return;
      }

      if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${selectedRecords.size} æ¡è®°å½•å—ï¼Ÿ`)) {
        return;
      }

      try {
        for (const key of selectedRecords) {
          const [type, id] = key.split(':');
          const endpoint = type === 'sleep' ? '/api/sleep-records' : '/api/meal-records';
          await fetch(`${endpoint}/${id}`, { method: 'DELETE' });
        }
        alert('åˆ é™¤æˆåŠŸ');
        selectedRecords.clear();
        loadDeleteList();
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥');
      }
    }

    // ========================= æ–°å¢ï¼šæ—¶é—´è¡¨åŠŸèƒ½ =========================

    let currentCalendarDate = new Date();
    let allRecordsData = {}; // ç¼“å­˜æ‰€æœ‰è®°å½•æ•°æ®

    // åˆ‡æ¢è§†å›¾ç±»å‹
    function switchViewType(type) {
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // éšè—æ‰€æœ‰è§†å›¾
      document.querySelectorAll('.view-container').forEach(view => view.style.display = 'none');

      // æ˜¾ç¤ºé€‰ä¸­çš„è§†å›¾
      if (type === 'list') {
        document.getElementById('listView').style.display = 'block';
      } else if (type === 'schedule') {
        document.getElementById('scheduleView').style.display = 'block';
        renderWeeklySchedule();
      } else if (type === 'calendar') {
        document.getElementById('calendarView').style.display = 'block';
        renderCalendar(currentCalendarDate.getUTCFullYear(), currentCalendarDate.getUTCMonth());
      }
    }

    // æ¸²æŸ“å‘¨ä½œæ¯è¡¨
    async function renderWeeklySchedule() {
      const start = document.getElementById('filterStart').value;
      const end = document.getElementById('filterEnd').value;

      try {
        const sleepRes = await fetch(`/api/records/filter?type=sleep&start=${start}&end=${end}`);
        const sleepRecords = await sleepRes.json();

        const mealRes = await fetch(`/api/records/filter?type=meal&start=${start}&end=${end}`);
        const mealRecords = await mealRes.json();

        // æ„å»ºæ—¶é—´è¡¨æ•°æ®ç»“æ„ï¼šæŒ‰å°æ—¶ç»Ÿè®¡
        const scheduleData = {}; // {hour: {Mon: {...}, Tue: {...}, ...}}
        for (let i = 0; i < 24; i++) {
          scheduleData[i] = {0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: []};
        }

        // å¡«å…¥ç¡çœ æ•°æ®
        sleepRecords.forEach(record => {
          if (!record.start) return;
          const startTime = new Date(record.start);
          const endTime = new Date(record.display.split('-')[1] ? new Date(record.display.match(/\d{2}:\d{2}/)[0]) : startTime);

          const startHour = startTime.getUTCHours();
          const dayOfWeek = startTime.getUTCDay() === 0 ? 6 : startTime.getUTCDay() - 1;

          if (scheduleData[startHour]) {
            scheduleData[startHour][dayOfWeek].push({
              type: 'sleep',
              display: record.display
            });
          }
        });

        // å¡«å…¥é¥®é£Ÿæ•°æ®
        mealRecords.forEach(record => {
          if (!record.time) return;
          const time = new Date(record.time);
          const hour = time.getUTCHours();
          const dayOfWeek = time.getUTCDay() === 0 ? 6 : time.getUTCDay() - 1;

          if (scheduleData[hour]) {
            scheduleData[hour][dayOfWeek].push({
              type: 'meal',
              display: record.display
            });
          }
        });

        // æ¸²æŸ“è¡¨æ ¼
        const weekDays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
        let html = '<div class="schedule-grid">';

        // è¡¨å¤´
        html += '<div class="schedule-header" style="grid-column: 1;"></div>';
        weekDays.forEach(day => {
          html += `<div class="schedule-header">${day}</div>`;
        });

        // è¡Œæ•°æ®ï¼ˆ0-23å°æ—¶ï¼‰
        for (let hour = 0; hour < 24; hour++) {
          html += `<div class="schedule-time">${String(hour).padStart(2, '0')}:00</div>`;

          for (let day = 0; day < 7; day++) {
            html += '<div class="schedule-cell">';

            const items = scheduleData[hour][day];
            if (items.length > 0) {
              items.forEach((item, idx) => {
                if (item.type === 'sleep') {
                  html += `<div class="time-block sleep" style="top: ${idx * 15}px; height: 12px;" title="${item.display}"></div>`;
                } else {
                  html += `<div class="time-block meal" style="top: ${idx * 10}px;" title="${item.display}"></div>`;
                }
              });
            }

            html += '</div>';
          }
        }

        html += '</div>';
        document.getElementById('weeklySchedule').innerHTML = html;
      } catch (error) {
        console.error('æ¸²æŸ“å‘¨ä½œæ¯è¡¨å¤±è´¥:', error);
        document.getElementById('weeklySchedule').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      }
    }

    // æ¸²æŸ“æ—¥å†
    async function renderCalendar(year, month) {
      currentCalendarDate = new Date(Date.UTC(year, month, 1));
      const start = document.getElementById('filterStart').value;
      const end = document.getElementById('filterEnd').value;

      try {
        // åŠ è½½æ‰€æœ‰æ•°æ®
        const sleepRes = await fetch(`/api/records/filter?type=sleep&start=${start}&end=${end}`);
        const sleepRecords = await sleepRes.json();

        const mealRes = await fetch(`/api/records/filter?type=meal&start=${start}&end=${end}`);
        const mealRecords = await mealRes.json();

        // æŒ‰æ—¥æœŸåˆ†ç»„è®°å½•
        const recordsByDate = {};

        sleepRecords.forEach(record => {
          if (record.start) {
            const date = new Date(record.start);
            const dateStr = `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}`;
            if (!recordsByDate[dateStr]) recordsByDate[dateStr] = { sleep: [], meal: [] };
            recordsByDate[dateStr].sleep.push(record);
          }
        });

        mealRecords.forEach(record => {
          if (record.time) {
            const date = new Date(record.time);
            const dateStr = `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}`;
            if (!recordsByDate[dateStr]) recordsByDate[dateStr] = { sleep: [], meal: [] };
            recordsByDate[dateStr].meal.push(record);
          }
        });

        allRecordsData = recordsByDate;

        // ç”Ÿæˆæ—¥å†HTML
        const firstDay = new Date(Date.UTC(year, month, 1));
        const lastDay = new Date(Date.UTC(year, month + 1, 0));
        const prevLastDay = new Date(Date.UTC(year, month, 0));

        const startDate = new Date(firstDay);
        startDate.setUTCDate(startDate.getUTCDate() - firstDay.getUTCDay());

        let html = '';
        const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        weekDays.forEach(day => {
          html += `<div class="calendar-weekday">${day}</div>`;
        });

        // ç”Ÿæˆæ—¥æœŸå•å…ƒæ ¼
        let currentDate = new Date(startDate);
        for (let i = 0; i < 42; i++) {
          const isCurrentMonth = currentDate.getUTCMonth() === month;
          const dateStr = `${currentDate.getUTCFullYear()}-${String(currentDate.getUTCMonth() + 1).padStart(2, '0')}-${String(currentDate.getUTCDate()).padStart(2, '0')}`;
          const hasData = recordsByDate[dateStr] && (recordsByDate[dateStr].sleep.length > 0 || recordsByDate[dateStr].meal.length > 0);

          let cellClass = 'calendar-day';
          if (!isCurrentMonth) cellClass += ' other-month';
          if (hasData) cellClass += ' has-data';

          html += `<div class="${cellClass}" onclick="showDayDetails('${dateStr}')" style="cursor: pointer;">
            <div class="calendar-day-number">${currentDate.getUTCDate()}</div>`;

          if (hasData) {
            html += '<div class="calendar-indicators">';
            if (recordsByDate[dateStr].sleep.length > 0) {
              html += '<div class="indicator-dot sleep" title="ç¡çœ "></div>';
            }
            if (recordsByDate[dateStr].meal.length > 0) {
              html += '<div class="indicator-dot meal" title="é¥®é£Ÿ"></div>';
            }
            html += '</div>';
          }

          html += '</div>';
          currentDate.setUTCDate(currentDate.getUTCDate() + 1);
        }

        document.getElementById('calendarGrid').innerHTML = html;

        // æ›´æ–°æœˆä»½æ˜¾ç¤º
        const monthStr = `${year}å¹´ ${month + 1}æœˆ`;
        document.getElementById('calendarMonth').textContent = monthStr;

        // æ˜¾ç¤ºä»Šå¤©æˆ–ç¬¬ä¸€æ¡è®°å½•çš„è¯¦æƒ…
        const today = new Date();
        const todayStr = `${today.getUTCFullYear()}-${String(today.getUTCMonth() + 1).padStart(2, '0')}-${String(today.getUTCDate()).padStart(2, '0')}`;
        showDayDetails(todayStr);

      } catch (error) {
        console.error('æ¸²æŸ“æ—¥å†å¤±è´¥:', error);
        document.getElementById('calendarGrid').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      }
    }

    // æ˜¾ç¤ºç‰¹å®šæ—¥æœŸçš„è¯¦æƒ…
    function showDayDetails(dateStr) {
      const data = allRecordsData[dateStr];
      let html = '';

      if (!data || (data.sleep.length === 0 && data.meal.length === 0)) {
        html = '<div class="calendar-detail-title">' + dateStr + '</div><div style="color: #999; font-size: 13px;">æš‚æ— è®°å½•</div>';
      } else {
        const dateObj = new Date(dateStr + 'T00:00:00Z');
        const dateDisplay = `${String(dateObj.getUTCMonth() + 1).padStart(2, '0')}æœˆ${String(dateObj.getUTCDate()).padStart(2, '0')}æ—¥`;
        html = `<div class="calendar-detail-title">${dateDisplay}</div>`;

        if (data.sleep.length > 0) {
          html += '<div style="margin-bottom: 10px;"><strong style="color: #667eea;">ç¡çœ è®°å½•ï¼š</strong></div>';
          data.sleep.forEach(record => {
            html += `<div class="calendar-detail-item">${record.display}</div>`;
          });
        }

        if (data.meal.length > 0) {
          html += '<div style="margin-top: 10px; margin-bottom: 10px;"><strong style="color: #4facfe;">é¥®é£Ÿè®°å½•ï¼š</strong></div>';
          data.meal.forEach(record => {
            html += `<div class="calendar-detail-item">${record.display}</div>`;
          });
        }
      }

      document.getElementById('calendarDetail').innerHTML = html;
    }

    // ä¸Šæœˆ
    function previousMonth() {
      currentCalendarDate.setUTCMonth(currentCalendarDate.getUTCMonth() - 1);
      renderCalendar(currentCalendarDate.getUTCFullYear(), currentCalendarDate.getUTCMonth());
    }

    // ä¸‹æœˆ
    function nextMonth() {
      currentCalendarDate.setUTCMonth(currentCalendarDate.getUTCMonth() + 1);
      renderCalendar(currentCalendarDate.getUTCFullYear(), currentCalendarDate.getUTCMonth());
    }

    // é¡µé¢åŠ è½½
    window.addEventListener('load', init);
  </script>
</body>
</html>
