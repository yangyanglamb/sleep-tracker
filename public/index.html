<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¡çœ å’Œé¥®é£Ÿè®°å½•</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 30px 20px;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #666;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .button-group.full {
      grid-template-columns: 1fr;
    }

    button {
      padding: 15px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
    }

    .btn-sleep {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-sleep:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-wake {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .btn-wake:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4);
    }

    .btn-meal {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .btn-meal:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status-box {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #666;
    }

    .status-box.sleeping {
      border-left-color: #f5576c;
      background: #fff5f7;
    }

    .status-box.awake {
      border-left-color: #667eea;
      background: #f8f9fa;
    }

    .records-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      background: #fafafa;
    }

    .record-item {
      padding: 12px;
      background: white;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 14px;
      color: #333;
      border-left: 4px solid #667eea;
      animation: slideIn 0.3s ease;
    }

    .record-item.meal {
      border-left-color: #4facfe;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 14px;
    }

    .meal-type-selector {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .meal-btn {
      padding: 8px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      color: #666;
    }

    .meal-btn.active {
      border-color: #4facfe;
      background: #e3f2fd;
      color: #4facfe;
    }

    .meal-btn:hover {
      border-color: #4facfe;
    }

    @media (max-width: 480px) {
      .container {
        padding: 20px 15px;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }

      button {
        padding: 12px 16px;
        font-size: 14px;
      }

      .button-group {
        gap: 10px;
      }
    }

    .tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 10px;
      border: none;
      background: #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: #667eea;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âœ¨ ç¡çœ ä¸é¥®é£Ÿè®°å½•</h1>

    <!-- ç¡çœ éƒ¨åˆ† -->
    <div class="section">
      <div class="section-title">ç¡çœ ç®¡ç†</div>
      <div class="status-box awake" id="sleepStatus">
        å½“å‰çŠ¶æ€: æ¸…é†’
      </div>
      <div class="button-group">
        <button class="btn-sleep" onclick="startSleep()">ğŸ˜´ ç¡è§‰</button>
        <button class="btn-wake" onclick="endSleep()">ğŸŒ… èµ·åºŠ</button>
      </div>
    </div>

    <!-- åƒé¥­éƒ¨åˆ† -->
    <div class="section">
      <div class="section-title">é¥®é£Ÿè®°å½•</div>
      <div class="meal-type-selector">
        <button class="meal-btn active" data-meal="æ—©é¤" onclick="selectMealType(this)">æ—©é¤</button>
        <button class="meal-btn" data-meal="åˆé¤" onclick="selectMealType(this)">åˆé¤</button>
        <button class="meal-btn" data-meal="æ™šé¤" onclick="selectMealType(this)">æ™šé¤</button>
        <button class="meal-btn" data-meal="åŠ é¤" onclick="selectMealType(this)">åŠ é¤</button>
        <button class="meal-btn" data-meal="é¥®æ°´" onclick="selectMealType(this)">é¥®æ°´</button>
        <button class="meal-btn" data-meal="å…¶ä»–" onclick="selectMealType(this)">å…¶ä»–</button>
      </div>
      <button class="btn-meal" style="width: 100%;" onclick="recordMeal()">ğŸ½ï¸ è®°å½•åƒé¥­</button>
    </div>

    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('sleep')">ç¡çœ è®°å½•</button>
      <button class="tab-btn" onclick="switchTab('meal')">é¥®é£Ÿè®°å½•</button>
    </div>

    <!-- ç¡çœ è®°å½• -->
    <div id="sleepTab" class="tab-content active">
      <div class="records-container" id="sleepRecords">
        <div class="empty-state">æš‚æ— ç¡çœ è®°å½•</div>
      </div>
    </div>

    <!-- åƒé¥­è®°å½• -->
    <div id="mealTab" class="tab-content">
      <div class="records-container" id="mealRecords">
        <div class="empty-state">æš‚æ— é¥®é£Ÿè®°å½•</div>
      </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <a href="/manage.html" style="display: inline-block; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">ğŸ“‹ ç®¡ç†è®°å½•</a>
    </div>
  </div>

  <script>
    let currentMealType = 'æ—©é¤';

    // åˆå§‹åŒ–
    async function init() {
      await updateSleepStatus();
      await loadSleepRecords();
      await loadMealRecords();
      // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
      setInterval(async () => {
        await updateSleepStatus();
        await loadSleepRecords();
        await loadMealRecords();
      }, 30000);
    }

    // å¼€å§‹ç¡çœ 
    async function startSleep() {
      try {
        const response = await fetch('/api/sleep-start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await response.json();
        await updateSleepStatus();
        console.log(data.message);
      } catch (error) {
        console.error('é”™è¯¯:', error);
      }
    }

    // ç»“æŸç¡çœ 
    async function endSleep() {
      try {
        const response = await fetch('/api/sleep-end', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await response.json();
        await updateSleepStatus();
        await loadSleepRecords();
        if (data.display) {
          console.log('ç¡çœ è®°å½•:', data.display);
        }
      } catch (error) {
        console.error('é”™è¯¯:', error);
      }
    }

    // è®°å½•åƒé¥­
    async function recordMeal() {
      try {
        const response = await fetch('/api/meal-record', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mealType: currentMealType })
        });
        const data = await response.json();
        await loadMealRecords();
        console.log(data.message);
      } catch (error) {
        console.error('é”™è¯¯:', error);
      }
    }

    // æ›´æ–°ç¡çœ çŠ¶æ€
    async function updateSleepStatus() {
      try {
        const response = await fetch('/api/sleep-status');
        const data = await response.json();
        const statusBox = document.getElementById('sleepStatus');

        if (data.isSleeping) {
          const startTime = new Date(data.startTime);
          const now = new Date();
          const diffMinutes = Math.floor((now - startTime) / (1000 * 60));

          let timeText = '';
          if (diffMinutes < 60) {
            timeText = `å·²ç¡${diffMinutes}åˆ†é’Ÿ`;
          } else {
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            if (minutes === 0) {
              timeText = `å·²ç¡${hours}å°æ—¶`;
            } else {
              timeText = `å·²ç¡${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            }
          }

          statusBox.textContent = `ğŸ›Œ æ­£åœ¨ç¡çœ  - ${timeText}`;
          statusBox.className = 'status-box sleeping';
        } else {
          statusBox.textContent = 'å½“å‰çŠ¶æ€: æ¸…é†’';
          statusBox.className = 'status-box awake';
        }
      } catch (error) {
        console.error('é”™è¯¯:', error);
      }
    }

    // åŠ è½½ç¡çœ è®°å½•
    async function loadSleepRecords() {
      try {
        const response = await fetch('/api/sleep-records');
        const records = await response.json();
        const container = document.getElementById('sleepRecords');

        if (records.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— ç¡çœ è®°å½•</div>';
          return;
        }

        container.innerHTML = records.map(record =>
          `<div class="record-item">${record.display}</div>`
        ).join('');
      } catch (error) {
        console.error('é”™è¯¯:', error);
      }
    }

    // åŠ è½½åƒé¥­è®°å½•
    async function loadMealRecords() {
      try {
        const response = await fetch('/api/meal-records');
        const records = await response.json();
        const container = document.getElementById('mealRecords');

        if (records.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— é¥®é£Ÿè®°å½•</div>';
          return;
        }

        container.innerHTML = records.map(record =>
          `<div class="record-item meal">${record.display}</div>`
        ).join('');
      } catch (error) {
        console.error('é”™è¯¯:', error);
      }
    }

    // é€‰æ‹©åƒé¥­ç±»å‹
    function selectMealType(button) {
      document.querySelectorAll('.meal-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      currentMealType = button.getAttribute('data-meal');
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tab) {
      // æ›´æ–°æ ‡ç­¾æŒ‰é’®
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // æ›´æ–°å†…å®¹
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', init);
  </script>
</body>
</html>
